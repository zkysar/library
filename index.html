<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Library Events Calendar</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href='https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13.1/css/all.css' rel='stylesheet'>
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.css' rel='stylesheet'>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        .fc-event {
            cursor: pointer;
        }

        .ongoing-event {
            font-style: italic;
        }

        #map {
            height: 400px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>

<body>
    <div class="container mt-4">
        <h1 class="text-center mb-4">Library Events Calendar</h1>
        <div id="map"></div>
        <div id="calendar"></div>
    </div>

    <!-- Modal for event details -->
    <div class="modal fade" id="eventModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="eventDescription"></p>
                    <p id="eventLink"></p>
                </div>
            </div>
        </div>
    </div>


    <script>
        // Global state
        let events = [];
        let map;

        // Fetch events from events.json
        async function fetchEvents() {
            try {
                const response = await fetch('events.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error('Error loading events:', error);
                document.getElementById('calendar').innerHTML = '<div class="alert alert-danger">Error loading events. Please try again later.</div>';
                return [];
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.js'></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Initialize map
            if (!map) {
                map = L.map('map').setView([37.8715, -122.2730], 9);
            }
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: ' OpenStreetMap contributors'
            }).addTo(map);

            // Create markers for libraries
            const libraries = {};
            events.forEach(event => {
                const addressMatch = event.description.match(/Address: ([^\n]+)/i);
                if (addressMatch) {
                    const address = addressMatch[1].trim();
                    if (!libraries[address]) {
                        libraries[address] = {
                            name: event.description.match(/Library: ([^\n]+)/i)[1].trim(),
                            events: []
                        };
                    }
                    libraries[address].events.push(event);
                }
            });

            // Add markers to map
            for (const [address, library] of Object.entries(libraries)) {
                const geocodeUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`;
                fetch(geocodeUrl)
                    .then(response => response.json())
                    .then(data => {
                        if (data && data[0]) {
                            const marker = L.marker([data[0].lat, data[0].lon])
                                .addTo(map)
                                .bindPopup(`<b>${library.name}</b><br>${address}<br>${library.events.length} events`);
                        }
                    });
            }

            // Initialize calendar
            const calendarEl = document.getElementById('calendar');
            const calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                events: events,
                eventClick: function (info) {
                    const modal = new bootstrap.Modal(document.getElementById('eventModal'));
                    const modalTitle = document.querySelector('#eventModal .modal-title');
                    const modalBody = document.querySelector('#eventDescription');
                    const modalLink = document.querySelector('#eventLink');

                    modalTitle.textContent = info.event.title;
                    modalBody.textContent = info.event.extendedProps.description || 'No description available';

                    if (info.event.url) {
                        modalLink.innerHTML = `<a href="${info.event.url}" target="_blank" class="btn btn-primary">Event Details</a>`;
                    } else {
                        modalLink.innerHTML = '';
                    }

                    modal.show();
                }
            });
            calendar.render();
        }); 

        // Start the application when the page loads
        document.addEventListener('DOMContentLoaded', initializeApp);

        // Initialize the application
        async function initializeApp() {
            try {
                events = await fetchEvents();
                if (events.length === 0) return;

                // Initialize map
                if (!map) {
                    map = L.map('map').setView([37.8044, -122.2712], 10);
                }
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: ' OpenStreetMap contributors'
                }).addTo(map);

                // Process events for map
                const libraries = {};
                events.forEach(event => {
                    const addressMatch = event.description.match(/Address: ([^\n]+)/i);
                    if (addressMatch) {
                        const address = addressMatch[1].trim();
                        if (!libraries[address]) {
                            libraries[address] = [];
                        }
                        libraries[address].push(event);
                    }
                });

                // Add markers for each library
                Object.entries(libraries).forEach(([address, libraryEvents]) => {
                    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data && data.length > 0) {
                                const marker = L.marker([data[0].lat, data[0].lon]).addTo(map);
                                marker.bindPopup(`<b>${libraryEvents[0].description.match(/Library: ([^\n]+)/i)[1]}</b><br>${address}<br>Events: ${libraryEvents.length}`);
                            }
                        })
                        .catch(error => console.error('Error geocoding address:', error));
                });

                // Initialize calendar
                var calendarEl = document.getElementById('calendar');
                var calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'dayGridMonth',
                    headerToolbar: {
                        left: 'prev,next today',
                        center: 'title',
                        right: 'dayGridMonth,timeGridWeek,timeGridDay'
                    },
                    events: events,
                    eventClick: function(info) {
                        const modal = new bootstrap.Modal(document.getElementById('eventModal'));
                        const modalTitle = document.querySelector('#eventModal .modal-title');
                        const modalBody = document.querySelector('#eventModal .modal-body');
                        
                        modalTitle.textContent = info.event.title;
                        
                        let content = '';
                        if (info.event.extendedProps.description) {
                            content += info.event.extendedProps.description + '<br><br>';
                        }
                        if (info.event.url) {
                            content += `<a href="${info.event.url}" target="_blank">More Information</a>`;
                        }
                        
                        modalBody.innerHTML = content;
                        modal.show();
                    }
                });
                calendar.render();
            } catch (error) {
                console.error('Error initializing application:', error);
                document.getElementById('calendar').innerHTML = '<div class="alert alert-danger">Error loading calendar. Please try again later.</div>';
            }
        }

        // Start the application when the page loads
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>

</html>